# 阿里云轻量应用服务器部署详细步骤

## 📋 前置准备

- ✅ 已购买阿里云轻量应用服务器（2核2G）
- ✅ 服务器已选择 Docker 镜像
- ✅ 服务器 IP：`120.26.172.158`（根据你的实际情况）
- ✅ MongoDB Atlas 已配置（使用现有的连接字符串）

---

## 第一步：连接到服务器

### 方法一：使用阿里云控制台（推荐）

1. 登录阿里云控制台
2. 进入"轻量应用服务器"
3. 找到你的服务器实例
4. 点击"远程连接"
5. 选择"Workbench远程连接"或"SSH密钥连接"

### 方法二：使用 SSH 客户端

```bash
ssh root@120.26.172.158
```

（首次连接需要输入密码，密码在服务器详情页可以重置）

---

## 第二步：安装必要工具

连接到服务器后，执行以下命令：

```bash
# 更新系统
apt update && apt upgrade -y

# 安装 Docker（如果未安装）
curl -fsSL https://get.docker.com -o get-docker.sh
sh get-docker.sh

# 安装 Docker Compose
curl -L "https://github.com/docker/compose/releases/download/v2.20.0/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose
chmod +x /usr/local/bin/docker-compose

# 验证安装
docker --version
docker-compose --version
```

---

## 第三步：上传项目文件

### 方法一：使用 Git（推荐）

```bash
# 安装 Git
apt install git -y

# 克隆项目
cd /opt
git clone https://github.com/Bupoo123/AIO2.git
cd AIO2
```

### 方法二：使用 SCP（从本地电脑上传）

在你的本地电脑执行：

```bash
cd /Users/bupoo/Github/AIO2
scp -r . root@120.26.172.158:/opt/AIO2
```

---

## 第四步：配置环境变量

```bash
cd /opt/AIO2

# 创建 .env 文件
cp env.example .env

# 编辑 .env 文件
nano .env
```

在 `.env` 文件中配置：

```env
# MongoDB 连接配置（使用 MongoDB Atlas）
MONGODB_URI=mongodb+srv://AIO2admin:31493170@cluster0.gpq75zd.mongodb.net/jeyi-toolhub?retryWrites=true&w=majority

# JWT 密钥
JWT_SECRET=484a294c2d4f51bfa0767c012935105b4270d0247331e8168e2512f64638bac1

# 服务器配置
PORT=3000
NODE_ENV=production

# 前端地址（使用服务器 IP 或域名）
FRONTEND_URL=http://120.26.172.158
```

保存文件：按 `Ctrl+X`，然后按 `Y`，再按 `Enter`

---

## 第五步：配置防火墙

在阿里云控制台：

1. 进入服务器详情页
2. 点击"防火墙"标签
3. 添加规则：
   - **端口**：`80`（HTTP）
   - **协议**：TCP
   - **策略**：允许
   - **备注**：Web 服务

如果需要 HTTPS，也添加 `443` 端口。

---

## 第六步：部署应用

```bash
cd /opt/AIO2

# 给部署脚本执行权限
chmod +x deploy.sh

# 执行部署脚本
./deploy.sh
```

或者手动执行：

```bash
# 构建并启动服务
docker-compose up -d --build

# 查看日志
docker-compose logs -f
```

---

## 第七步：验证部署

### 1. 检查服务状态

```bash
docker-compose ps
```

应该看到 `backend` 和 `nginx` 两个容器都在运行。

### 2. 检查健康状态

```bash
curl http://localhost/health
```

应该返回 JSON 响应。

### 3. 访问网站

在浏览器中访问：`http://120.26.172.158`

应该能看到登录页面。

---

## 第八步：创建管理员账号

```bash
cd /opt/AIO2

# 进入后端容器
docker-compose exec backend sh

# 在容器内执行
cd /app/backend
node scripts/createAdmin.js

# 退出容器
exit
```

管理员账号：
- 用户名：`admin`
- 密码：`123456`

---

## 🔧 常用命令

### 查看日志
```bash
# 查看所有服务日志
docker-compose logs -f

# 查看后端日志
docker-compose logs -f backend

# 查看 Nginx 日志
docker-compose logs -f nginx
```

### 重启服务
```bash
docker-compose restart
```

### 停止服务
```bash
docker-compose down
```

### 更新代码
```bash
# 拉取最新代码
git pull

# 重新构建并启动
docker-compose up -d --build
```

### 查看容器状态
```bash
docker-compose ps
docker ps
```

---

## 🔒 安全建议

### 1. 修改默认密码
- 定期更换服务器 root 密码
- 使用 SSH 密钥认证（更安全）

### 2. 配置域名和 SSL
- 在阿里云购买域名
- 配置域名解析到服务器 IP
- 使用 Let's Encrypt 免费 SSL 证书

### 3. 定期备份
- 使用阿里云快照功能定期备份
- 备份 MongoDB 数据库

---

## ⚠️ 常见问题

### 1. 端口被占用
```bash
# 检查端口占用
netstat -tulpn | grep :80

# 停止占用端口的服务
docker-compose down
```

### 2. 无法连接 MongoDB
- 检查 MongoDB Atlas 网络访问设置
- 确保允许服务器 IP 访问
- 检查连接字符串是否正确

### 3. 服务无法启动
```bash
# 查看详细日志
docker-compose logs backend

# 检查环境变量
docker-compose exec backend env
```

### 4. 静态文件 404
- 检查 `nginx.conf` 配置
- 检查 `frontend` 目录是否存在
- 查看 Nginx 日志：`docker-compose logs nginx`

---

## 📞 需要帮助？

如果遇到问题：
1. 查看日志：`docker-compose logs -f`
2. 检查服务状态：`docker-compose ps`
3. 验证配置文件是否正确

---

部署完成后，你的网站就可以通过 `http://你的IP地址` 访问了！🎉

